<?php

class QuizTaking extends QuizTestCase {

  public static function getInfo() {
    return array(
      'name' => t('Quiz taking'),
      'description' => t('Unit test for Quiz take behaviors.'),
      'group' => t('Quiz'),
    );
  }

  /**
   * Test the repeat until correct behavior.
   */
  public function testQuestionRepeatUntilCorrect() {
    $this->fail('Write this test.');
  }

  /**
   * Test the quiz resuming from database.
   */
  public function testQuizResuming() {
    $this->drupalLogin($this->admin);
    // Resuming is default behavior.
    $quiz_node = $this->drupalCreateQuiz(array('allow_resume' => 1));

    // 2 questions.
    $question_node1 = $this->drupalCreateNode(array('type' => 'truefalse', 'correct_answer' => 1));
    $this->linkQuestionToQuiz($question_node1, $quiz_node);
    $question_node2 = $this->drupalCreateNode(array('type' => 'truefalse', 'correct_answer' => 1));
    $this->linkQuestionToQuiz($question_node2, $quiz_node);

    // Answer a question
    $this->drupalLogin($this->user);
    $this->drupalGet("node/{$quiz_node->nid}/take");
    $this->drupalGet("node/{$quiz_node->nid}/take/1");
    $this->assertResponse(200);
    $this->drupalGet("node/{$quiz_node->nid}/take/1");
    $this->drupalPost(NULL, array(
      "question[$question_node1->nid]" => 1,
      ), t('Next'));

    // Login again.
    $this->drupalLogin($this->user);
    $this->drupalGet("node/{$quiz_node->nid}/take");
    $this->assertText('Resuming');
    // Answer the question without selecting anything.
    $this->drupalPost(NULL, array(
      "question[$question_node1->nid]" => 1,
      ), t('Next'));
  }

  /**
   * Test the quiz availability tests.
   */
  public function testQuizAvailability() {
    // Within range.
    $quiz_node = $this->drupalCreateQuiz(array(
      'quiz_always' => 0,
      'quiz_open' => REQUEST_TIME - 86400,
      'quiz_close' => REQUEST_TIME + 86400,
    ));
    $this->drupalGet("node/{$quiz_node->nid}");
    $this->assertNoText('This quiz is closed.');

    // Starts in the future.
    $quiz_node = $this->drupalCreateQuiz(array(
      'quiz_always' => 0,
      'quiz_open' => REQUEST_TIME + 86400,
      'quiz_close' => REQUEST_TIME + 86401,
    ));
    $this->drupalGet("node/{$quiz_node->nid}");
    $this->assertText('This quiz is closed.');

    // Ends in the past.
    $quiz_node = $this->drupalCreateQuiz(array(
      'quiz_always' => 0,
      'quiz_open' => REQUEST_TIME - 86400,
      'quiz_close' => REQUEST_TIME - 86401,
    ));
    $this->drupalGet("node/{$quiz_node->nid}");
    $this->assertText('This quiz is closed.');

    // Always available.
    $quiz_node = $this->drupalCreateQuiz(array(
      'quiz_always' => 1,
      'quiz_open' => REQUEST_TIME + 86400,
      'quiz_close' => REQUEST_TIME - 86401,
    ));
    $this->drupalGet("node/{$quiz_node->nid}");
    $this->assertNoText('This quiz is closed.');
  }

}
